

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>PIV keys support &mdash; The Bastion 3.08.01 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/thebastion.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="SCP support" href="scp.html" />
    <link rel="prev" title="Access management" href="basics/access_management.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> The Bastion
          

          
          </a>

          
            
            
              <div class="version">
                3.08.01
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Presentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../presentation/principles.html">Principles</a></li>
<li class="toctree-l1"><a class="reference internal" href="../presentation/features.html">Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../presentation/security.html">Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq.html">FAQ</a></li>
</ul>
<p class="caption"><span class="caption-text">Installation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../installation/basic.html">Basic Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation/advanced.html">Advanced Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation/upgrading.html">Upgrading</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation/docker.html">Sandbox using Docker</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation/tests.html">Running Tests</a></li>
</ul>
<p class="caption"><span class="caption-text">Usage</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="basics/index.html">The basics</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">PIV keys support</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="#without-a-policy">Without a policy</a></li>
<li class="toctree-l2"><a class="reference internal" href="#per-account-policy">Per-account policy</a></li>
<li class="toctree-l2"><a class="reference internal" href="#global-policy">Global policy</a></li>
<li class="toctree-l2"><a class="reference internal" href="#temporary-grace-period">Temporary grace period</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="scp.html">SCP support</a></li>
<li class="toctree-l1"><a class="reference internal" href="http_proxy.html">HTTPS Proxy</a></li>
</ul>
<p class="caption"><span class="caption-text">Administration</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../administration/configuration/index.html">Configuration files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../administration/logs.html">Logs</a></li>
</ul>
<p class="caption"><span class="caption-text">Plugins</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../plugins/admin/index.html">admin plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../plugins/group-aclkeeper/index.html">group-aclkeeper plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../plugins/group-gatekeeper/index.html">group-gatekeeper plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../plugins/group-owner/index.html">group-owner plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../plugins/open/index.html">open plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../plugins/restricted/index.html">restricted plugins</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">The Bastion</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>PIV keys support</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/using/piv.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="piv-keys-support">
<h1><a class="toc-backref" href="#id1">PIV keys support</a><a class="headerlink" href="#piv-keys-support" title="Permalink to this headline">¶</a></h1>
<div class="contents topic" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#piv-keys-support" id="id1">PIV keys support</a><ul>
<li><a class="reference internal" href="#introduction" id="id2">Introduction</a></li>
<li><a class="reference internal" href="#without-a-policy" id="id3">Without a policy</a></li>
<li><a class="reference internal" href="#per-account-policy" id="id4">Per-account policy</a></li>
<li><a class="reference internal" href="#global-policy" id="id5">Global policy</a></li>
<li><a class="reference internal" href="#temporary-grace-period" id="id6">Temporary grace period</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="introduction">
<h2><a class="toc-backref" href="#id2">Introduction</a><a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>The Bastion supports enabling a policy forcing accounts SSH ingress keys to originate from a known hardware token,
ensuring that the private SSH key is only stored on this hardware token, and not on the filesystem.</p>
<p>Currently, only Yubico keys implementing PIV can be verified this way. In that case, each individual hardware token
has a builtin Certificate Authority, signed by a well-known Yubico certificate, hence proving that the hardware token
is known and legit.</p>
<p>This builtin CA, in turn, emits an attestation certificate each time a new PIV key is generated on the hardware token,
hence proving that the bikey (private and public) has been generated by this individual hardware token.
Other metadata is included in the attestation, such as the firmware version, the serial number of the token,
the <em>TouchPolicy</em> and <em>PinPolicy</em>. Note that you may decide to overwrite the builtin CA by a one of your own,
possibly signed by a CA of your company. This would ensure not only that the SSH key is provided by the device,
but also that the device has been provided by your company.</p>
<p>Please refer to
the <a class="reference external" href="https://developers.yubico.com/PIV/Introduction/PIV_attestation.html">Yubico PIV attestation page</a> and
the <a class="reference external" href="https://developers.yubico.com/yubico-piv-tool/YubiKey_PIV_introduction.html">Yubico PIV tool page</a>
for more information.</p>
</div>
<div class="section" id="without-a-policy">
<h2><a class="toc-backref" href="#id3">Without a policy</a><a class="headerlink" href="#without-a-policy" title="Permalink to this headline">¶</a></h2>
<p>If you want to support PIV keys without making those mandatory, you don't have anything to do:
those keys are just regular RSA/ECDSA keys and they <em>just work</em> with The Bastion.
In that case, after having properly configured your hardware token with a key in slot 9a,
you can just use <a class="reference internal" href="../plugins/open/selfAddIngressKey.html"><span class="doc">selfAddIngressKey</span></a> to add the key to your bastion account, and call it a day.
As a quick guidance, on a Yubikey you can usually generate a key in the proper slot this way,
after you've setup a management key:</p>
<p>Now, if you want the bastion to be aware that this key is from a hardware token, you shall use the <code class="docutils literal notranslate"><span class="pre">--piv</span></code> option
to <a class="reference internal" href="../plugins/open/selfAddIngressKey.html"><span class="doc">selfAddIngressKey</span></a>. This won't do anything special per-se, except storing
the certificates information, and showing the details of the PIV key in command outputs
such as <a class="reference internal" href="../plugins/open/selfListIngressKeys.html"><span class="doc">selfListIngressKeys</span></a>.
Note however that if in the future you enable the PIV enforcing policy either on your account or globally,
this key will be considered valid, contrary to all the keys added without the <code class="docutils literal notranslate"><span class="pre">--piv</span></code> option,
even if these keys happen to be PIV ones. To add a key with the <code class="docutils literal notranslate"><span class="pre">--piv</span></code> option, you'll need the SSH public key
as usual, but also the attestation certificate and the key certificate.
Step by step details on how to get those are out of the scope of this document,
but again as a quick guidance, on a Yubikey you can usually get those this way:</p>
<p>When you'll have added your key, you'll see a few more details than usual:</p>
<p>As you can see, we added the public key as usual but were also asked for the two certificates.
On the bastion answer, right before the fingerprint of the key, we have a line starting with <em>PIV:</em>,
with some metadata extracted from the certificate.</p>
</div>
<div class="section" id="per-account-policy">
<h2><a class="toc-backref" href="#id4">Per-account policy</a><a class="headerlink" href="#per-account-policy" title="Permalink to this headline">¶</a></h2>
<p>If you want to force several accounts to only use certified PIV keys, you can set the option per-account
using the <a class="reference internal" href="../plugins/restricted/accountPIV.html"><span class="doc">accountPIV</span></a> command, see its documentation page for all the possible options.
The main takeaways are:</p>
<ul class="simple">
<li>If you want an account to only have PIV keys, set the <code class="docutils literal notranslate"><span class="pre">enforce</span></code> policy for this account</li>
<li>If you want an account to never require PIV keys, even if the global policy would require it,
set the <code class="docutils literal notranslate"><span class="pre">never</span></code> policy (useful for accounts used by automated workflows)</li>
</ul>
</div>
<div class="section" id="global-policy">
<h2><a class="toc-backref" href="#id5">Global policy</a><a class="headerlink" href="#global-policy" title="Permalink to this headline">¶</a></h2>
<p>If you want to apply a policy bastion-wide, please refer to the <span class="xref std std-ref">ingressRequiresPIV</span> option.
This policy can still be overridden per-account if needed, see above.</p>
</div>
<div class="section" id="temporary-grace-period">
<h2><a class="toc-backref" href="#id6">Temporary grace period</a><a class="headerlink" href="#temporary-grace-period" title="Permalink to this headline">¶</a></h2>
<p>If you enable the PIV policy globally or on several accounts, you'll soon find out that sometimes people forget
or lose their PIV-enabled hardware tokens, effectively locking them out of the bastion.
There is a <em>temporary grace period</em> feature you can use to handle such cases nicely:</p>
<p>What happens here is that, for a duration of 48 hours, this account will behave as if no PIV policy was enforced:
non-PIV keys are allowed again. If this account had non-PIV keys before its policy was set to enforce,
those keys are even restored (can be viewed using <a class="reference internal" href="../plugins/open/selfListIngressKeys.html"><span class="doc">selfListIngressKeys</span></a> as usual),
so that they can easily connect again. However, after the grace period expires, their policy will go back to
what it was previously, and all the non-PIV keys will be disabled again.
This event is logged, so you can easily link this event from your SIEM to a potential ticket to your Helpdesk
for a hardware key replacement, or such.</p>
<p>This mechanism allows some flexibility (avoiding sending people back home just because they forgot their hardware key),
while still enforcing a high-level security policy with the proper processes in place.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="scp.html" class="btn btn-neutral float-right" title="SCP support" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="basics/access_management.html" class="btn btn-neutral float-left" title="Access management" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2022, OVHcloud

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>